<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shiv HD Enterprise - Real-time Video</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #ff3b30; --accent: #ffcc00; --bg: #000; }
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: var(--bg); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

        /* 50-50 HD Camera Split */
        #video-grid { display: flex; flex-direction: column; height: 100vh; width: 100vw; }
        .video-box { position: relative; flex: 1; border: 1px solid #222; overflow: hidden; background: #111; }
        video { width: 100%; height: 100%; object-fit: cover; transition: opacity 0.5s ease; }
        
        /* Labels & UI Overlays */
        .user-tag { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6); color: #fff; padding: 4px 12px; border-radius: 15px; font-size: 12px; border: 1px solid var(--accent); }

        /* Powerful Chat System (Server Driven) */
        #chat-overlay { position: absolute; bottom: 100px; left: 15px; right: 15px; height: 180px; pointer-events: none; display: flex; flex-direction: column; }
        #chat-history { flex: 1; overflow-y: auto; pointer-events: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; mask-image: linear-gradient(transparent, black 20%); }
        .msg { background: rgba(255,255,255,0.2); color: white; padding: 8px 15px; border-radius: 18px; width: fit-content; max-width: 80%; backdrop-filter: blur(5px); animation: slideIn 0.3s ease; }
        
        /* Professional Control Bar */
        .master-controls { position: absolute; bottom: 25px; width: 100%; display: flex; justify-content: center; align-items: center; gap: 20px; z-index: 100; }
        .btn { border: none; outline: none; transition: transform 0.2s; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .btn:active { transform: scale(0.9); }
        .next-btn { width: 70px; height: 70px; border-radius: 50%; background: var(--primary); color: white; font-weight: bold; font-size: 16px; }
        .gift-btn { width: 50px; height: 50px; border-radius: 50%; background: var(--accent); font-size: 20px; }

        /* Gift Animation Layer */
        #gift-layer { position: absolute; inset: 0; pointer-events: none; z-index: 99; }

        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body>

<div id="video-grid">
    <div class="video-box" id="remote-box">
        <div class="user-tag">STRANGER HD</div>
        <video id="remoteVideo" autoplay playsinline></video>
    </div>
    <div class="video-box" id="local-box">
        <div class="user-tag">YOU (LIVE)</div>
        <video id="localVideo" autoplay muted playsinline></video>
    </div>
</div>

<div id="chat-overlay">
    <div id="chat-history"></div>
    <div style="display: flex; gap: 10px; pointer-events: auto; margin-top: 10px;">
        <input type="text" id="chatInput" placeholder="Say something..." style="flex:1; border-radius: 20px; border:none; padding:10px;">
        <button onclick="sendMsg()" style="border-radius: 20px; border:none; padding:0 15px; background:var(--accent);">Send</button>
    </div>
</div>

<div class="master-controls">
    <button class="btn gift-btn" onclick="sendGift('‚ù§Ô∏è')">‚ù§Ô∏è</button>
    <button class="btn next-btn" onclick="findNewMatch()">NEXT</button>
    <button class="btn gift-btn" onclick="sendGift('üëë')">üëë</button>
</div>

<div id="gift-layer"></div>

<script>
    const socket = io("https://live-server-lrw7.onrender.com");
    let myPeer, myStream, partnerId, currentRoom;

    // Camera Setup (Full HD Logic)
    async function initCamera() {
        myStream = await navigator.mediaDevices.getUserMedia({ 
            video: { width: 1920, height: 1080, frameRate: 30 }, 
            audio: true 
        });
        document.getElementById('localVideo').srcObject = myStream;
        setupPeer();
    }

    function setupPeer() {
        myPeer = new Peer();
        myPeer.on('open', id => {
            console.log("Connected to Shiv Network: " + id);
            socket.emit('join-shiv-network', { name: "User_" + id.slice(0,4) });
        });

        myPeer.on('call', call => {
            call.answer(myStream);
            call.on('stream', stream => {
                document.getElementById('remoteVideo').srcObject = stream;
            });
        });
    }

    // Matching Logic
    socket.on('match-ready', data => {
        partnerId = data.partnerId;
        currentRoom = data.room;
        if(data.role === 'caller') {
            const call = myPeer.call(partnerId, myStream);
            call.on('stream', stream => {
                document.getElementById('remoteVideo').srcObject = stream;
            });
        }
    });

    // Chat History Logic (From Server)
    function sendMsg() {
        const input = document.getElementById('chatInput');
        if(input.value && partnerId) {
            const data = { to: partnerId, msg: input.value, from: "Me" };
            socket.emit('message', data);
            addMessage("Me", input.value);
            input.value = "";
        }
    }

    socket.on('message-receive', data => {
        addMessage("Stranger", data.msg);
    });

    function addMessage(sender, text) {
        const div = document.createElement('div');
        div.className = 'msg';
        div.innerHTML = `<b>${sender}:</b> ${text}`;
        const hist = document.getElementById('chat-history');
        hist.appendChild(div);
        hist.scrollTop = hist.scrollHeight;
    }

    // Gift Logic
    function sendGift(type) {
        if(partnerId) socket.emit('send-gift', { to: partnerId, giftType: type });
    }

    socket.on('animate-gift', data => {
        const gift = document.createElement('div');
        gift.innerHTML = data.type;
        gift.style.cssText = `position:absolute; left:50%; bottom:20%; font-size:50px; animation: giftPop 1s forwards;`;
        document.getElementById('gift-layer').appendChild(gift);
        setTimeout(() => gift.remove(), 1000);
    });

    function findNewMatch() {
        location.reload(); // Quick reset for next match
    }

    initCamera();
</script>

<style>
    @keyframes giftPop { 
        0% { transform: scale(0) translateY(0); opacity: 0; }
        50% { transform: scale(2) translateY(-100px); opacity: 1; }
        100% { transform: scale(1) translateY(-200px); opacity: 0; }
    }
</style>
</body>
</html>

